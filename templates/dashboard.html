<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Library Habit Tracker â€” Dashboard</title>

  <!-- Chart.js (kept for future use) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- QR scanner -->
  <script src="https://unpkg.com/html5-qrcode"></script>

  <style>
    :root {
      --card: #ffffff;
      --muted: #475569;
      --accent: #2563eb;
      --radius: 12px;
      --shadow: 0 8px 24px rgba(15,23,42,0.06);
    }
    *{box-sizing:border-box;font-family:Inter,system-ui,'Poppins',sans-serif}

    /* Using the uploaded local image path (will be transformed by your deploy tool) */
    body{
      margin:0;
      background-image: url('/mnt/data/OIP (1).jpg');
      background-size:cover;
      background-position:center;
      background-attachment:fixed;
      padding:20px;
      color:#0f172a;
    }

    .container{max-width:900px;margin:0 auto;}
    header{
      display:flex;justify-content:space-between;align-items:center;
      margin-bottom:18px;
      background:rgba(255,255,255,0.88);
      padding:14px;border-radius:12px;
      backdrop-filter:blur(6px);
    }
    h1{font-size:22px;margin:0;font-weight:600}

    .card{
      background:rgba(255,255,255,0.95);
      border-radius:var(--radius);
      padding:16px;
      box-shadow:var(--shadow);
      margin-bottom:14px;
      backdrop-filter:blur(6px);
    }
    label{display:block;margin-bottom:6px;color:var(--muted);font-size:14px}
    select,input[type="text"],input[type="number"]{
      width:100%;padding:10px;border-radius:8px;border:1px solid #d1d5db;font-size:14px;margin-bottom:8px;background:white;
    }

    .btn{background:var(--accent);color:white;padding:8px 12px;border-radius:8px;border:none;cursor:pointer}
    .btn-ghost{background:transparent;color:var(--accent);border:1px solid #dbeafe;padding:8px 10px;border-radius:8px;cursor:pointer}
    .small{font-size:13px;padding:6px 10px}
    .row{display:flex;gap:10px;align-items:center}
    .result{
      display:flex;justify-content:space-between;align-items:center;padding:10px;
      border-radius:8px;border:1px solid #f1f5f9;background:#fcfdff;margin-bottom:8px
    }
    .meta{color:var(--muted);font-size:13px}

    /* Heatmap */
    .heat-grid { display:grid; grid-template-columns: repeat(53, 9px); gap:4px; padding:6px; }
    .heat-cell{width:9px;height:9px;border-radius:2px;background:#eef2ff;border:1px solid rgba(15,23,42,0.03)}

    /* Streak Controls */
    .streak-controls{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:12px;
      margin-top:12px;
    }
    .streak-btn{
      width:36px;height:36px;font-size:20px;font-weight:bold;
      display:flex;justify-content:center;align-items:center;
      border-radius:10px;border:1px solid #cbd5e1;
      background:white;color:#334155;cursor:pointer;
      transition:0.15s;
    }
    .streak-btn:hover{background:#eef2ff}

    .manual-row{display:flex;gap:8px;margin-top:12px;align-items:center}
    .manual-row input[type="number"]{width:120px}
    @media (max-width:640px){
      .row{flex-direction:column}
      .heat-grid{grid-template-columns:repeat(20,9px)}
      .manual-row{flex-direction:column;align-items:stretch}
      .manual-row input[type="number"]{width:100%}
    }
  </style>
</head>
<body>

<div class="container">

  <header>
    <h1>ðŸ“š Library Habit Tracker</h1>
    <div style="color:var(--muted)">Welcome back â€” keep reading!</div>
  </header>

  <!-- Feeling -->
  <div class="card">
    <label>How are you feeling today?</label>
    <select id="feeling">
      <option>Select feeling</option>
      <option>ðŸ˜Š Happy</option>
      <option>ðŸ˜Œ Calm</option>
      <option>ðŸ¤© Motivated</option>
      <option>ðŸ˜” Tired</option>
      <option>ðŸ˜¤ Stressed</option>
      <option>ðŸ˜´ Sleepy</option>
    </select>
    <div class="meta">Selected: <b id="feelingNow">â€”</b></div>
  </div>

  <!-- Search -->
  <div class="card">
    <label>Search Computer Science Books</label>
    <div class="row">
      <input id="searchBox" type="text" placeholder="e.g. algorithms, OS, DBMS" />
      <button class="btn small" onclick="doSearch()">Search</button>
    </div>
    <div id="searchResults" style="margin-top:10px"></div>
  </div>

  <!-- QR -->
  <div class="card">
    <label>QR / ISBN Scanner</label>
    <div class="row">
      <button class="btn small" onclick="startScanner()">Start Scan</button>
      <button class="btn-ghost small" onclick="stopScanner()">Stop</button>
      <label class="btn-ghost small" style="cursor:pointer;">
        Upload QR
        <input id="qrFile" type="file" accept="image/*" style="display:none" onchange="scanFromFile(event)">
      </label>
    </div>
    <div id="reader" style="margin-top:10px;height:180px;background:#000;color:white;display:flex;justify-content:center;align-items:center;border-radius:8px;">
      Ready
    </div>
    <div id="scanInfo" class="meta" style="margin-top:6px"></div>
  </div>

  <!-- STREAK SECTION -->
  <div class="card">
    <label>Reading Streak</label>

    <!-- current streak display -->
    <div style="font-size:22px;font-weight:700;text-align:center" id="streakCount">0 days</div>
    <div class="meta" style="text-align:center" id="totalMins">0 minutes total</div>

    <!-- +/- quick controls -->
    <div class="streak-controls" aria-hidden="false">
      <div class="streak-btn" onclick="decStreak()" title="Decrease today's minutes (reduces streak if becomes zero)">âˆ’</div>
      <div class="streak-btn" onclick="incStreak()" title="Increase today's minutes (adds a reading day)">+</div>
    </div>

    <!-- Manual input (Option 1 chosen) -->
    <div class="manual-row" style="justify-content:center">
      <input id="manualDays" type="number" min="0" placeholder="Enter streak days" />
      <button class="btn small" onclick="setStreakFromInput()">Update Streak</button>
      <button class="btn-ghost small" onclick="clearStreak()">Reset</button>
    </div>

    <div style="margin-top:12px;text-align:center">
      <button class="btn small" onclick="logTodayMinutesPrompt()">Log Todayâ€™s Minutes</button>
    </div>
  </div>

  <!-- HEATMAP -->
  <div class="card">
    <label>Reading Heatmap (Year)</label>
    <div id="heatGrid" class="heat-grid"></div>
  </div>

  <!-- AI SUMMARY -->
  <div class="card">
    <label>AI Summary Generator</label>
    <div class="row">
      <input id="summaryBookId" type="number" placeholder="Book ID">
      <button class="btn small" onclick="generateSummary()">Generate</button>
    </div>
    <div id="summaryResult" class="meta" style="margin-top:8px"></div>
  </div>

  <!-- TIMER -->
  <div class="card">
    <label>Read-Aloud / Focus Timer</label>
    <div style="font-size:22px;font-weight:700;text-align:center" id="timerDisplay">00:00:00</div>
    <div class="row" style="margin-top:8px;justify-content:center">
      <button class="btn small" onclick="startTimer()">Start</button>
      <button class="btn-ghost small" onclick="pauseTimer()">Pause</button>
      <button class="btn-ghost small" onclick="stopTimer()">Stop</button>
    </div>
  </div>

</div>

<script>
/* -------------------- Basic UI handlers -------------------- */
document.getElementById("feeling").addEventListener("change", e=>{
  document.getElementById("feelingNow").textContent = e.target.value;
});

/* -------------------- Search (uses your /api/search) -------------------- */
async function doSearch(){
  const q = document.getElementById("searchBox").value.trim();
  const out = document.getElementById("searchResults");
  if(!q){ out.innerHTML=""; return; }
  out.innerHTML = "Searching...";
  try {
    const res = await fetch('/api/search?q='+encodeURIComponent(q));
    const data = await res.json();
    out.innerHTML = "";
    if(!data || data.length === 0) { out.innerHTML = '<div class="meta">No results</div>'; return; }
    data.forEach(b => {
      out.innerHTML += `
        <div class="result">
          <div><b>${b.title}</b><br><span class="meta">${b.author || ''}</span></div>
          <button class="btn small" onclick="location.href='/read-book/${b.id}'">Read</button>
        </div>`;
    });
  } catch (e) {
    out.innerHTML = '<div class="meta">Search failed</div>';
    console.error(e);
  }
}

/* -------------------- QR scanner -------------------- */
let scanner = null;
async function startScanner(){
  if(scanner) return;
  scanner = new Html5Qrcode("reader");
  try {
    const cams = await Html5Qrcode.getCameras();
    if(!cams || !cams.length) { document.getElementById('scanInfo').textContent = 'No camera found'; return; }
    await scanner.start(cams[0].id, { fps: 10, qrbox: 200 }, decoded => {
      document.getElementById('scanInfo').textContent = 'Scanned: ' + decoded;
      if(/^\d+$/.test(decoded)) location.href = '/read-book/' + decoded;
      else { document.getElementById('searchBox').value = decoded; doSearch(); }
    }, err => {
      /* ignore frame errors */
    });
  } catch(err) {
    console.error(err);
    document.getElementById('scanInfo').textContent = 'Camera access denied or not available';
  }
}
function stopScanner(){
  if(!scanner) return;
  scanner.stop().then(()=>{ scanner.clear(); scanner = null; document.getElementById('scanInfo').textContent = 'Scanner stopped'; }).catch(()=>{ scanner=null; });
}
function scanFromFile(e){
  const file = e.target.files[0];
  if(!file) return;
  const qr = new Html5Qrcode("reader");
  qr.scanFile(file, true).then(decoded => {
    document.getElementById('scanInfo').textContent = 'Scanned: ' + decoded;
    if(/^\d+$/.test(decoded)) location.href = '/read-book/' + decoded;
    else { document.getElementById('searchBox').value = decoded; doSearch(); }
    qr.clear();
  }).catch(err=>{ document.getElementById('scanInfo').textContent = 'No QR found in image'; });
}

/* -------------------- Heatmap + Streak logic -------------------- */
/* heatData stores minutes read for each day-of-year index (0..364) */
let heatData = new Array(365).fill(0);

/* helper: day-of-year index */
function getDayOfYear(d = new Date()){
  const start = new Date(d.getFullYear(), 0, 0);
  const diff = d - start;
  return Math.floor(diff / (1000*60*60*24));
}

/* color scale */
function heatColor(min){
  if(!min || min <= 0) return '#eef2ff';
  if(min < 15) return '#c7d2fe';
  if(min < 30) return '#818cf8';
  return '#4338ca';
}

/* render heatmap */
function renderHeat(){
  const grid = document.getElementById('heatGrid');
  grid.innerHTML = '';
  for(let i=0;i<365;i++){
    const cell = document.createElement('div');
    cell.className = 'heat-cell';
    cell.style.background = heatColor(heatData[i]);
    cell.title = ${i+1}: ${heatData[i] || 0} minutes;
    grid.appendChild(cell);
  }
}

/* compute streak = consecutive days ending today with minutes>0 */
function computeStreak(){
  const today = getDayOfYear();
  let s = 0;
  for(let i = today; i >= 0; i--){
    if(!heatData[i] || heatData[i] === 0) break;
    s++;
  }
  document.getElementById('streakCount').textContent = s + ' days';
  const total = heatData.reduce((a,b)=>a + (b || 0), 0);
  document.getElementById('totalMins').textContent = total + ' minutes total';
}

/* quick manual +/- controls (adds or removes minutes for today) */
function incStreak(){
  const d = getDayOfYear();
  heatData[d] = (heatData[d] || 0) + 30; // add 30 minutes
  renderHeat(); computeStreak();
}
function decStreak(){
  const d = getDayOfYear();
  heatData[d] = Math.max(0, (heatData[d] || 0) - 30);
  renderHeat(); computeStreak();
}

/* Option 1: Manual Input (user typed days) */
function setStreakFromInput(){
  const val = parseInt(document.getElementById('manualDays').value, 10);
  if(isNaN(val) || val < 0){
    alert('Enter a valid non-negative number of days');
    return;
  }

  // We will set 'val' consecutive days ending today as reading days.
  // Simple approach: clear previous heatData and mark last 'val' days with default minutes (e.g., 25).
  // NOTE: This resets other days in the year (intended behavior for "set streak manually").
  heatData = new Array(365).fill(0);
  const today = getDayOfYear();
  for(let i = 0; i < val; i++){
    const idx = today - i;
    if(idx < 0) break;
    heatData[idx] = 25; // default minutes per day for manual set
  }
  renderHeat(); computeStreak();
}

/* Reset heat/streak (clears all) */
function clearStreak(){
  if(!confirm('Reset all reading data for the year?')) return;
  heatData = new Array(365).fill(0);
  renderHeat(); computeStreak();
}

/* Log minutes for today (prompt) */
function logTodayMinutesPrompt(){
  const v = prompt('Minutes read today (numeric):', '30');
  const m = parseInt(v,10);
  if(isNaN(m) || m <= 0) { alert('Enter valid minutes'); return; }
  const d = getDayOfYear();
  heatData[d] = (heatData[d] || 0) + m;
  renderHeat(); computeStreak();
}

/* -------------------- Summary (demo) -------------------- */
function generateSummary(){
  const id = document.getElementById('summaryBookId').value;
  const out = document.getElementById('summaryResult');
  if(!id){ out.textContent = 'Enter Book ID'; return; }
  out.textContent = 'Generating...';
  setTimeout(()=> out.textContent = 'Short summary (demo): Clear explanation of core concepts.', 700);
}

/* -------------------- Timer -------------------- */
let tSec = 0, interval = null;
function formatTime(s){
  const h = String(Math.floor(s/3600)).padStart(2,'0');
  const m = String(Math.floor((s%3600)/60)).padStart(2,'0');
  const sec = String(s%60).padStart(2,'0');
  return ${h}:${m}:${sec};
}
function startTimer(){
  if(interval) return;
  interval = setInterval(()=> {
    tSec++;
    document.getElementById('timerDisplay').textContent = formatTime(tSec);
  }, 1000);
}
function pauseTimer(){
  clearInterval(interval); interval = null;
}
function stopTimer(){
  clearInterval(interval); interval = null;
  const mins = Math.floor(tSec / 60);
  if(mins > 0){
    const d = getDayOfYear();
    heatData[d] = (heatData[d] || 0) + mins;
    renderHeat(); computeStreak();
  }
  tSec = 0;
  document.getElementById('timerDisplay').textContent = '00:00:00';
}

/* -------------------- Init -------------------- */
renderHeat();
computeStreak();
</script>

</body>
</html>
