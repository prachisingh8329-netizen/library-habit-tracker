<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Library Habit Tracker â€” Dashboard</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- QR scanner -->
  <script src="https://unpkg.com/html5-qrcode"></script>

  <style>
    :root {
      --card: #ffffff;
      --muted: #475569;
      --accent: #2563eb;
      --radius: 12px;
      --shadow: 0 8px 24px rgba(15,23,42,0.06);
    }
    *{box-sizing:border-box;font-family:Inter,system-ui,'Poppins',sans-serif}
    body{
      margin:0;
      background-image:url('https://i.postimg.cc/L6tcvZtZ/library-blur.jpg');
      background-size:cover;
      background-position:center;
      background-attachment:fixed;
      padding:20px;
      color:#0f172a;
    }
    .container{max-width:900px;margin:0 auto;}
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;background:rgba(255,255,255,0.8);padding:14px;border-radius:12px;backdrop-filter:blur(6px);}
    h1{font-size:20px;margin:0}
    .card{
      background:rgba(255,255,255,0.86);
      border-radius:var(--radius);
      padding:16px;
      box-shadow:var(--shadow);
      margin-bottom:14px;
      backdrop-filter:blur(4px);
    }
    label{display:block;margin-bottom:6px;color:var(--muted);font-size:14px}
    select,input[type="text"],input[type="number"]{
      width:100%;padding:10px;border-radius:8px;border:1px solid #d1d5db;font-size:14px;margin-bottom:8px;background:rgba(255,255,255,0.8);
    }
    .btn{background:var(--accent);color:white;padding:8px 12px;border-radius:8px;border:none;cursor:pointer}
    .btn-ghost{background:transparent;color:var(--accent);border:1px solid #dbeafe;padding:8px 10px;border-radius:8px;cursor:pointer}
    .small{font-size:13px;padding:6px 10px}
    .row{display:flex;gap:10px}
    .result{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:8px;border:1px solid #f1f5f9;background:#fcfdff;margin-bottom:8px}
    .meta{color:var(--muted);font-size:13px}
    .heat-grid { display:grid; grid-template-columns: repeat(53, 9px); gap:4px; padding:6px; background:transparent }
    .heat-cell{width:9px;height:9px;border-radius:2px;background:#eef2ff;border:1px solid rgba(15,23,42,0.03)}
    @media (max-width:640px){ .row{flex-direction:column} .heat-grid{grid-template-columns:repeat(20,9px)} }
  </style>
</head>
<body>

<div class="container">

  <header>
    <h1>ðŸ“š Library Habit Tracker</h1>
    <div style="color:var(--muted)">Welcome back, Reader!</div>
  </header>

  <!-- FEELING -->
  <div class="card">
    <label>How are you feeling today?</label>
    <select id="feeling">
      <option>Select feeling</option>
      <option>ðŸ˜Š Happy</option>
      <option>ðŸ˜Œ Calm</option>
      <option>ðŸ¤© Motivated</option>
      <option>ðŸ˜” Tired</option>
      <option>ðŸ˜¤ Stressed</option>
      <option>ðŸ˜´ Sleepy</option>
    </select>
    <div style="font-size:13px;color:var(--muted)">Selected: <b id="feelingNow">â€”</b></div>
  </div>

  <!-- SEARCH -->
  <div class="card">
    <label>Search Computer Science Books</label>
    <div class="row">
      <input id="searchBox" type="text" placeholder="e.g. algorithms, OS, CN, DBMS" />
      <button class="btn small" onclick="doSearch()">Search</button>
    </div>
    <div id="searchResults" style="margin-top:10px"></div>
  </div>

  <!-- QR -->
  <div class="card">
    <label>QR / ISBN Scanner</label>
    <div class="row">
      <button class="btn small" onclick="startScanner()">Start Scan</button>
      <button class="btn-ghost small" onclick="stopScanner()">Stop</button>
      <label class="btn-ghost small">
        Upload QR
        <input id="qrFile" type="file" accept="image/*" style="display:none" onchange="scanFromFile(event)">
      </label>
    </div>
    <div id="reader" style="margin-top:10px;height:180px;background:#000;color:white;display:flex;justify-content:center;align-items:center;border-radius:8px;overflow:hidden">
      Ready
    </div>
    <div id="scanInfo" class="meta" style="margin-top:6px"></div>
  </div>

  <!-- STREAK -->
  <div class="card">
    <label>Reading Streak</label>
    <div style="font-size:22px;font-weight:700" id="streakCount">0 days</div>
    <div class="meta" id="totalMins">0 minutes total</div>
    <button class="btn small" style="margin-top:10px" onclick="logTodayMinutesPrompt()">Log Todayâ€™s Minutes</button>
  </div>

  <!-- HEATMAP -->
  <div class="card">
    <label>Reading Heatmap (Year)</label>
    <div id="heatGrid" class="heat-grid"></div>
  </div>

  <!-- AI SUMMARY -->
  <div class="card">
    <label>AI Summary Generator</label>
    <div class="row">
      <input id="summaryBookId" type="number" placeholder="Book ID (e.g. 1)">
      <button class="btn small" onclick="generateSummary()">Generate</button>
    </div>
    <div id="summaryResult" class="meta"></div>
  </div>

  <!-- TIMER -->
  <div class="card">
    <label>Read-Aloud / Focus Timer</label>
    <div style="font-size:22px;font-weight:700" id="timerDisplay">00:00:00</div>
    <div class="row" style="margin-top:8px">
      <button class="btn small" onclick="startTimer()">Start</button>
      <button class="btn-ghost small" onclick="pauseTimer()">Pause</button>
      <button class="btn-ghost small" onclick="stopTimer()">Stop</button>
    </div>
    <div class="meta" style="margin-top:5px">Adds minutes to streak automatically</div>
  </div>

</div>

<script>
/* ----------------------------------------------------
   FEELINGS
---------------------------------------------------- */
document.getElementById("feeling").addEventListener("change", e=>{
  document.getElementById("feelingNow").textContent = e.target.value;
});

/* ----------------------------------------------------
   SEARCH
---------------------------------------------------- */
async function doSearch(){
  const q = document.getElementById("searchBox").value.trim();
  const out = document.getElementById("searchResults");
  if(!q){ out.innerHTML=""; return; }
  out.innerHTML = "Searching...";

  const res = await fetch("/api/search?q="+q);
  const data = await res.json();

  out.innerHTML = "";
  data.forEach(b=>{
    out.innerHTML += `
      <div class="result">
        <div>
          <b>${b.title}</b><br>
          <span class="meta">${b.author}</span>
        </div>
        <button class="btn small" onclick="location.href='/read-book/${b.id}'">Read</button>
      </div>
    `;
  });
}

/* ----------------------------------------------------
   QR SCANNER
---------------------------------------------------- */
let scanner=null;

async function startScanner(){
  if(scanner) return;
  scanner = new Html5Qrcode("reader");
  const cams = await Html5Qrcode.getCameras();
  if(!cams.length) return;
  scanner.start(cams[0].id,{fps:10,qrbox:200},qr=>{
    document.getElementById("scanInfo").textContent="Scanned: " + qr;
    if(/^\d+$/.test(qr)) location.href="/read-book/"+qr;
  });
}
function stopScanner(){
  if(scanner){
    scanner.stop();
    scanner.clear();
    scanner=null;
  }
  document.getElementById("scanInfo").textContent="Stopped";
}
function scanFromFile(e){
  const file=e.target.files[0];
  if(!file) return;
  const qr=new Html5Qrcode("reader");
  qr.scanFile(file,true).then(dec=>{
    document.getElementById("scanInfo").textContent="Scanned: "+dec;
  });
}

/* ----------------------------------------------------
   HEATMAP + REAL STREAK
---------------------------------------------------- */
let heatData = Array.from({length:365}, ()=> Math.floor(Math.random()*25));

function heatColor(min){
  if(min<=0) return "#eef2ff";
  if(min<10) return "#c7d2fe";
  if(min<25) return "#818cf8";
  return "#4338ca";
}

function getDayOfYear(date){
  const start = new Date(date.getFullYear(),0,0);
  const diff = date-start;
  return Math.floor(diff/(1000*60*60*24));
}

function renderHeat(){
  let grid=document.getElementById("heatGrid");
  grid.innerHTML="";
  for(let i=0;i<365;i++){
    const c=document.createElement("div");
    c.className="heat-cell";
    c.style.background=heatColor(heatData[i]);
    grid.appendChild(c);
  }
}

function computeStreak(){
  let today=getDayOfYear(new Date());
  let s=0;
  for(let i=today;i>=0;i--){
    if(!heatData[i]||heatData[i]===0) break;
    s++;
  }
  document.getElementById("streakCount").textContent=s+" days";
  const total=heatData.reduce((a,b)=>a+b,0);
  document.getElementById("totalMins").textContent=total+" minutes total";
}

function logTodayMinutesPrompt(){
  let m=parseInt(prompt("Minutes read today?","25"));
  if(!m||m<=0) return alert("Enter valid minutes");
  let day=getDayOfYear(new Date());
  heatData[day]=(heatData[day]||0)+m;
  renderHeat();
  computeStreak();
}

/* ----------------------------------------------------
   AI SUMMARY
---------------------------------------------------- */
function generateSummary(){
  let id=document.getElementById("summaryBookId").value;
  let out=document.getElementById("summaryResult");
  if(!id){ out.textContent="Enter Book ID"; return; }
  out.textContent="Generating...";
  setTimeout(()=>{
    out.textContent="Short summary: This book explains core concepts with clarity and real examples. (Demo)";
  },700);
}

/* ----------------------------------------------------
   TIMER
---------------------------------------------------- */
let tSec=0, interval=null;

function format(s){
  let h=String(Math.floor(s/3600)).padStart(2,"0");
  let m=String(Math.floor((s%3600)/60)).padStart(2,"0");
  let se=String(s%60).padStart(2,"0");
  return `${h}:${m}:${se}`;
}

function startTimer(){
  if(interval) return;
  interval=setInterval(()=>{
    tSec++;
    document.getElementById("timerDisplay").textContent=format(tSec);
  },1000);
}

function pauseTimer(){
  clearInterval(interval);
  interval=null;
}

function stopTimer(){
  clearInterval(interval);
  interval=null;

  let mins=Math.floor(tSec/60);
  if(mins>0){
    let day=getDayOfYear(new Date());
    heatData[day]=(heatData[day]||0)+mins;
    renderHeat();
    computeStreak();
  }

  tSec=0;
  document.getElementById("timerDisplay").textContent="00:00:00";
}

/* INIT */
renderHeat();
computeStreak();
</script>

</body>
</html>
