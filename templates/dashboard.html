<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Library Habit Tracker ‚Äî Advanced Dashboard</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- QR Scanner -->
  <script src="https://unpkg.com/html5-qrcode"></script>

  <style>
    :root{
      --bg1: linear-gradient(120deg,#d5dee7,#ffafbd,#ffc3a0,#a1c4fd);
      --card: rgba(255,255,255,0.85);
      --muted:#374151;
      --accent:#4da3ff;
      --radius:14px;
    }
    *{box-sizing:border-box;font-family:Inter,ui-sans-serif,system-ui,'Poppins',sans-serif}
    body{
      margin:0;
      background:var(--bg1);
      min-height:100vh;
      color:#0f172a;
      -webkit-font-smoothing:antialiased;
    }

    .wrap{
      max-width:1200px;margin:28px auto;padding:18px;
      display:grid;
      grid-template-columns: 320px 1fr;
      gap:20px;
    }

    .card{
      background:var(--card);
      border-radius:var(--radius);
      padding:16px;
      box-shadow:0 10px 30px rgba(2,6,23,0.08);
    }

    .card h3{margin:0 0 12px;font-size:18px;color:var(--muted)}

    .left-col{
      display:flex;
      flex-direction:column;
      gap:18px;
    }

    #moodPie{
      max-width:160px !important;
      max-height:160px !important;
      margin:auto;
      display:block;
    }

    .right-top{
      display:grid;
      grid-template-columns: 1fr 420px;
      gap:18px;
      margin-bottom:18px;
    }

    /* Search box small */
    #searchInput{
      padding:8px 12px;
      border-radius:8px;
      border:1px solid #d1d5db;
      font-size:14px;
      width:100%;
      max-width:280px;
      margin-bottom:8px;
    }

    .search-list{
      max-height:320px;
      overflow:auto;
      background:rgba(0,0,0,0.03);
      border-radius:10px;
      padding:8px;
    }

    .result-item{
      padding:10px;
      background:white;
      margin-bottom:8px;
      border-radius:8px;
      box-shadow:0 4px 12px rgba(0,0,0,0.06);
      cursor:pointer;
    }

    #reader{
      width:100%;
      height:220px;
      border-radius:10px;
      background:black;
      color:white;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:600;
    }

    .heat-grid{
      display:grid;
      grid-template-columns: repeat(53, 12px);
      gap:4px;
    }

    .heat-cell{
      width:12px;
      height:12px;
      border-radius:3px;
    }

    /* Page Prediction */
    .predictor input{
      padding:8px;
      border-radius:8px;
      border:1px solid #e5e7eb;
      width:100%;
    }
  </style>
</head>

<body>
<div class="wrap">
  <!-- LEFT COLUMN -->
  <div class="left-col">

    <!-- Mood Pie -->
    <div class="card">
      <h3>Mood Distribution (Past Week)</h3>
      <canvas id="moodPie"></canvas>

      <div style="text-align:center;margin-top:10px;font-size:14px">
        <strong>Current Mood:</strong> <span id="curMood">üòä Happy</span>
      </div>

      <div style="display:flex;flex-wrap:wrap;gap:6px;margin-top:10px;justify-content:center">
        <button onclick="setMood('üòä Happy')" class="btn">üòä</button>
        <button onclick="setMood('üòå Calm')" class="btn">üòå</button>
        <button onclick="setMood('ü§© Motivated')" class="btn">ü§©</button>
        <button onclick="setMood('üòî Tired')" class="btn">üòî</button>
        <button onclick="setMood('üò§ Stressed')" class="btn">üò§</button>
        <button onclick="setMood('üò¥ Sleepy')" class="btn">üò¥</button>
      </div>
    </div>

    <!-- Heatmap Small -->
    <div class="card">
      <h3>Reading Streak Heatmap (Small View)</h3>

      <div style="font-size:13px;margin-bottom:6px;color:#6b7280">
        Darker = more minutes read
      </div>

      <div id="heatmap" style="overflow:auto;padding-bottom:6px;"></div>
    </div>

  </div>
  <!-- END LEFT COLUMN -->


  <!-- RIGHT COLUMN -->
  <div style="display:flex;flex-direction:column;gap:18px">

    <!-- SEARCH + QR -->
    <div class="right-top">

      <!-- SEARCH BOX -->
      <div class="card">
        <h3>Search Computer Science Books</h3>

        <input id="searchInput" placeholder="Search CS Books..." />

        <div id="searchResults" class="search-list"></div>
      </div>

      <!-- QR SCANNER -->
      <div class="card">
        <h3>Scan Book (QR / ISBN)</h3>

        <div style="display:flex;gap:8px;margin-bottom:10px">
          <button class="btn" onclick="startScanner()">üì∑ Scan</button>

          <label class="btn" style="background:#6366f1;cursor:pointer;">
            üìÅ Upload QR
            <input type="file" id="qrUpload" accept="image/*" style="display:none" onchange="scanFromFile(event)">
          </label>
        </div>

        <div id="reader">Ready to Scan...</div>

        <div id="scanDetails" style="margin-top:10px;font-size:14px;color:#374151"></div>
      </div>

    </div>
    <!-- END RIGHT-TOP -->


    <!-- HEATMAP + PAGE PREDICTION -->
    <div style="display:grid;grid-template-columns:1fr 360px;gap:18px">

      <!-- BIG HEATMAP -->
      <div class="card">
        <h3>Yearly Reading Heatmap</h3>
        <div id="bigHeatmap"></div>
      </div>

      <!-- PAGE PREDICTION -->
      <div class="card predictor">
        <h3>Page-Time Prediction</h3>

        <div>
          <label>Pages read today</label>
          <input id="pagesToday" type="number" value="30">
        </div>

        <div>
          <label>Total pages of book</label>
          <input id="totalPages" type="number" value="300">
        </div>

        <div>
          <label>Reading speed (pages/min)</label>
          <input id="speed" type="number" step="0.1" value="0.5">
        </div>

        <button class="btn" onclick="predictFinish()" style="margin-top:10px">Predict</button>

        <div id="predictionText" style="font-size:16px;margin-top:10px;font-weight:600"></div>
        <div id="predictionDetails" style="font-size:13px;color:#6b7280;margin-top:6px"></div>
      </div>

    </div>

  </div>
  <!-- END RIGHT COLUMN -->
</div>
<!-- ===================================================== -->
<!-- =============== JAVASCRIPT SECTION =================== -->
<!-- ===================================================== -->

<script>
/* --------------------- MOOD PIE CHART ---------------------- */
const moodCtx = document.getElementById('moodPie').getContext('2d');

let moodData = {
  labels: ['Happy','Calm','Motivated','Tired','Stressed','Sleepy'],
  datasets:[{
    data: [12, 8, 20, 5, 3, 2],
    backgroundColor: ['#facc15','#60a5fa','#34d399','#f97316','#fb7185','#94a3b8']
  }]
};

const moodPie = new Chart(moodCtx, {
  type: 'doughnut',
  data: moodData,
  options: {
    plugins:{ legend:{ position:'bottom' } }
  }
});

function setMood(mood){
  document.getElementById("curMood").textContent = mood;

  let index = moodData.labels.findIndex(l => mood.includes(l));
  if(index >= 0){
    moodData.datasets[0].data[index] += 1;
    moodPie.update();
  }
}


/* --------------------- BOOK DATA ---------------------- */
const csBooks = [
  { id:1, title:"Introduction to Algorithms (CLRS)", author:"Cormen", pages:1312 },
  { id:2, title:"Operating System Concepts", author:"Silberschatz", pages:976 },
  { id:3, title:"Computer Networks", author:"Tanenbaum", pages:880 },
  { id:4, title:"Database System Concepts", author:"Korth", pages:1184 },
  { id:5, title:"Let Us C", author:"Yashwant Kanetkar", pages:700 },
  { id:6, title:"Python Crash Course", author:"Eric Matthes", pages:544 }
];


/* ---------------------- SEARCH ------------------------ */
const searchInput = document.getElementById("searchInput");
const searchResults = document.getElementById("searchResults");

searchInput.addEventListener("input", () => {
  const q = searchInput.value.toLowerCase();
  searchResults.innerHTML = "";

  if(!q.trim()) return;

  let results = csBooks.filter(b => 
    b.title.toLowerCase().includes(q) || 
    b.author.toLowerCase().includes(q)
  );

  results.forEach(book => {
    const div = document.createElement("div");
    div.className = "result-item";
    div.innerHTML = `<b>${book.title}</b><br><small>${book.author}</small>`;
    div.onclick = () => openBookInternal(book);
    searchResults.appendChild(div);
  });
});


/* ---------------------- BOOK DETAILS + CHAPTERS ------------------------ */
function openBookInternal(book){
  searchResults.innerHTML = `
    <div style="padding:14px;background:white;border-radius:12px;">
      <h2>${bo
