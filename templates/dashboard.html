<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Library Habit Tracker â€” Advanced Dashboard</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- html5-qrcode -->
  <script src="https://unpkg.com/html5-qrcode"></script>

  <style>
    :root{
      --bg1: linear-gradient(120deg,#d5dee7,#ffafbd,#ffc3a0,#a1c4fd);
      --card: rgba(255,255,255,0.85);
      --muted:#374151;
      --accent:#4da3ff;
      --radius:14px;
    }
    *{box-sizing:border-box;font-family:Inter,ui-sans-serif,system-ui,'Poppins',sans-serif}
    body{
      margin:0;
      background:var(--bg1);
      min-height:100vh;
      color:#0f172a;
      -webkit-font-smoothing:antialiased;
    }

    .wrap{
      max-width:1200px;margin:28px auto;padding:18px;
      display:grid;grid-template-columns: 320px 1fr;gap:20px;
    }

    /* Left column (mood pie + heatmap small view) */
    .left-col {
      display:flex;flex-direction:column;gap:18px;
    }
    .card{
      background:var(--card);border-radius:var(--radius);padding:16px;box-shadow:0 10px 30px rgba(2,6,23,0.08);
    }
    .card h3{margin:0 0 12px;font-size:18px;color:var(--muted)}
    .mini { display:flex;gap:12px;align-items:center; }

    /* Right area top: search + scanner */
    .right-top { display:grid; grid-template-columns: 1fr 420px; gap:18px; margin-bottom:18px; }
    .search-list { max-height:320px; overflow:auto; padding:8px; border-radius:10px; background:rgba(0,0,0,0.02); }
    .result-item{ padding:10px;border-radius:8px;margin-bottom:8px;background:white;cursor:pointer; box-shadow:0 4px 12px rgba(2,6,23,0.04); }
    .result-item small{color: #6b7280}

    /* QR area */
    #reader { width:100%; height:320px; border-radius:10px; overflow:hidden; background:#000; display:flex;align-items:center;justify-content:center;color:white;font-weight:600 }

    /* Heatmap (big) */
    .heat-row { display:flex; gap:6px; align-items:center; margin-top:10px; }
    .heat-grid {
      display:grid;
      grid-template-columns: repeat(53, 12px);
      gap:4px;
      align-items:center;
    }
    .heat-cell {
      width:12px;height:12px;border-radius:3px;background:#f3f4f6;border:1px solid rgba(0,0,0,0.04);
    }

    /* page-time panel */
    .predictor { display:flex; flex-direction:column; gap:8px; }
    .predictor input { padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.08) }
    .predictor .big { font-size:20px;font-weight:700;color:var(--muted) }

    /* Responsive */
    @media (max-width: 980px){
      .wrap{ grid-template-columns: 1fr; padding:12px;}
      .right-top { grid-template-columns: 1fr; }
      .heat-grid { grid-template-columns: repeat(18, 12px); }
    }
  </style>
</head>
<body>

<div class="wrap">

  <!-- LEFT column -->
  <div class="left-col">

    <!-- Mood Pie -->
    <div class="card">
      <h3>Mood Distribution (Past week)</h3>
      <div style="display:flex;gap:12px;align-items:center">
        <canvas id="moodPie" width="200" height="200"></canvas>
        <div style="flex:1">
          <div style="margin-bottom:6px"><strong>Current mood:</strong> <span id="curMood">ðŸ¤© Motivated</span></div>
          <div style="margin-bottom:6px">Tap a mood slice to set as today.</div>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button onclick="setMood('ðŸ˜Š Happy')">ðŸ˜Š Happy</button>
            <button onclick="setMood('ðŸ˜Œ Calm')">ðŸ˜Œ Calm</button>
            <button onclick="setMood('ðŸ¤© Motivated')">ðŸ¤© Motivated</button>
            <button onclick="setMood('ðŸ˜” Tired')">ðŸ˜” Tired</button>
            <button onclick="setMood('ðŸ˜¤ Stressed')">ðŸ˜¤ Stressed</button>
            <button onclick="setMood('ðŸ˜´ Sleepy')">ðŸ˜´ Sleepy</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Heatmap -->
    <div class="card">
      <h3>Reading Streak Heatmap (Year)</h3>
      <div style="display:flex;gap:12px">
        <div>
          <div style="font-size:12px;color:#6b7280;margin-bottom:8px">Darker = more minutes read</div>
          <div id="heatLegend" style="display:flex;gap:6px;align-items:center;margin-bottom:10px;">
            <div style="width:12px;height:12px;background:#f3f4f6;border-radius:3px"></div><small style="color:#6b7280">0</small>
            <div style="width:12px;height:12px;background:#dbeafe;border-radius:3px"></div><small style="color:#6b7280">10</small>
            <div style="width:12px;height:12px;background:#93c5fd;border-radius:3px"></div><small style="color:#6b7280">30</small>
            <div style="width:12px;height:12px;background:#1e90ff;border-radius:3px"></div><small style="color:#6b7280">60+</small>
          </div>
          <div id="heatmap" style="width: 100%; overflow:auto; padding-bottom:6px;">
            <!-- heat grid inserted by JS -->
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- RIGHT column -->
  <div style="display:flex;flex-direction:column;gap:18px">

    <!-- Top: search list + QR scanner -->
    <div class="right-top">

      <!-- search & results -->
      <div class="card">
        <h3>Search Computer Science Books</h3>
        <input id="searchInput" placeholder="Type 'algorithm', 'python', 'os'..." style="padding:10px;border-radius:8px;border:1px solid #e6e6e6;width:100%;margin-bottom:8px" />
        <div class="search-list" id="searchResults"></div>
      </div>

      <!-- QR scanner + details -->
      <div class="card">
        <h3>Scan Book (QR / ISBN)</h3>
        <div id="reader">Camera off â€” click Start Scan</div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button class="btn" onclick="startScanner()">Start Scan</button>
          <button class="btn" onclick="stopScanner()" style="background:#ef4444">Stop</button>
        </div>

        <div id="scanDetails" style="margin-top:12px;color:var(--muted)"></div>
      </div>

    </div>

    <!-- Next row: Page-time predictor & big heatmap -->
    <div style="display:grid;grid-template-columns:1fr 360px;gap:18px">

      <!-- wide: (reusing heatmap larger view) -->
      <div class="card">
        <h3>Yearly Reading Heatmap</h3>
        <div id="bigHeatmap" style="overflow:auto"></div>
      </div>

      <!-- side predictor -->
      <div class="card predictor">
        <h3>Page-Time Prediction</h3>
        <div>
          <label>Pages read today</label>
          <input id="pagesToday" type="number" min="0" value="30" />
        </div>
        <div>
          <label>Total pages of book</label>
          <input id="totalPages" type="number" min="1" value="300" />
        </div>
        <div>
          <label>Reading speed (pages / minute)</label>
          <input id="speed" type="number" min="0.01" step="0.01" value="0.5" />
        </div>

        <div style="margin-top:8px">
          <button class="btn" onclick="predictFinish()">Predict finish time</button>
        </div>

        <div style="margin-top:12px">
          <div class="big" id="predictionText" style="font-size:16px"></div>
          <div style="margin-top:8px;color:#6b7280;font-size:13px" id="predictionDetails"></div>
        </div>
      </div>

    </div>

  </div>
</div>

<script>
/* ----------------- Mood Pie (Chart.js) ----------------- */
const moodCtx = document.getElementById('moodPie').getContext('2d');
let moodData = {
  labels: ['Happy','Calm','Motivated','Tired','Stressed','Sleepy'],
  datasets:[{ data: [12,8,20,5,3,2], backgroundColor: ['#facc15','#60a5fa','#34d399','#f97316','#fb7185','#94a3b8'] }]
};
const moodPie = new Chart(moodCtx, {
  type: 'doughnut',
  data: moodData,
  options: {
    plugins:{legend:{position:'bottom'}},
    onClick: (evt, elements) => {
      if (elements.length) {
        const idx = elements[0].index;
        const label = moodData.labels[idx];
        setMood(label);
      }
    }
  }
});
function setMood(label){
  document.getElementById('curMood').textContent = label;
  // bump one value slightly for demo + update chart
  const idx = moodData.labels.indexOf(label);
  if (idx>=0) moodData.datasets[0].data[idx] += 1;
  moodPie.update();
}

/* -------------- Computer Science Search DB -------------- */
const csBooks = [
  { id:1, title:"Introduction to Algorithms (CLRS)", author:"Cormen et al.", pages:1312 },
  { id:2, title:"Operating System Concepts", author:"Silberschatz", pages:976 },
  { id:3, title:"Computer Networks", author:"Tanenbaum", pages:880 },
  { id:4, title:"Database System Concepts", author:"Korth", pages:1184 },
  { id:5, title:"Data Structures & Algorithms in Java", author:"Lafore", pages:720 },
  { id:6, title:"Let Us C", author:"Y. Kanetkar", pages:700 },
  { id:7, title:"Python Crash Course", author:"E. Matthes", pages:544 }
];

const searchInput = document.getElementById('searchInput');
const searchResults = document.getElementById('searchResults');
searchInput.addEventListener('input', () => {
  const q = searchInput.value.trim().toLowerCase();
  searchResults.innerHTML = '';
  if (!q) return;
  const filtered = csBooks.filter(b => b.title.toLowerCase().includes(q) || (b.author && b.author.toLowerCase().includes(q)));
  filtered.forEach(b => {
    const div = document.createElement('div');
    div.className = 'result-item';
    div.innerHTML = `<strong>${b.title}</strong><br><small>${b.author} â€¢ ${b.pages} pages</small>`;
    div.onclick = () => openBookInternal(b);
    searchResults.appendChild(div);
  });
});

function openBookInternal(book){
  // open internal read page route
  // if you use Flask route /read-book/<id>, it will open there
  window.location.href = `/read-book/${book.id}`;
}

/* ----------------- QR Scanner ----------------- */
let scanner = null;
function startScanner(){
  if (scanner) { scanner.render(onScanSuccess, onScanError); return; }
  scanner = new Html5Qrcode("reader");
  Html5Qrcode.getCameras().then(devices => {
    const cameraId = devices && devices.length ? devices[0].id : null;
    scanner.start(cameraId, { fps:10, qrbox:250 }, onScanSuccess, onScanError)
      .catch(err => { document.getElementById('scanDetails').innerText = 'Camera error: ' + err; });
  }).catch(err => {
    document.getElementById('scanDetails').innerText = 'No camera: ' + err;
  });
}
function stopScanner(){
  if (!scanner) return;
  scanner.stop().then(() => scanner.clear()).catch(()=>{});
}
async function onScanSuccess(decodedText, decodedResult){
  // For demo we try treat text as isbn or title
  stopScanner();
  document.getElementById('scanDetails').innerText = 'Scanned: ' + decodedText;
  // Try to find a matching CS book by id/title
  const t = decodedText.toLowerCase();
  const found = csBooks.find(b => b.title.toLowerCase().includes(t) || (''+b.id)===t );
  if (found) {
    setTimeout(()=> openBookInternal(found), 600);
  } else {
    // show as searched item
    const div = document.createElement('div');
    div.className = 'result-item';
    div.innerHTML = `<strong>${decodedText}</strong><br><small>Scanned text â€” try search</small>`;
    searchResults.prepend(div);
  }
}
function onScanError(err){ /* ignore quietly */ }

/* --------------- Heatmap generation (demo data) --------------- */
/* We will create a 365-cell grid arranged in 53 columns (weeks) like GitHub */
function makeHeatData(){
  // Generate demo minutes read per day (0..120)
  const days = 365;
  const arr = new Array(days).fill(0).map(()=> Math.floor(Math.random()*100)); // minutes
  return arr;
}
const heatData = makeHeatData();

// small heatmap (compact)
function renderHeatmapSmall(){
  const container = document.getElementById('heatmap');
  container.innerHTML = '';
  // show weeks horizontally â€” we will show as columns of 7 vertical cells simplified
  const cols = 53;
  const weeks = [];
  for (let w=0; w<cols; w++){
    const col = document.createElement('div');
    col.style.display='flex';col.style.flexDirection='column';col.style.gap='4px';
    // pick 7 days for this column
    for (let d=0; d<7; d++){
      const idx = w*7 + d;
      const cell = document.createElement('div');
      const minutes = heatData[idx] || 0;
      cell.className='heat-cell';
      cell.style.background = heatColor(minutes);
      cell.title = `Day ${idx+1}: ${minutes} min`;
      col.appendChild(cell);
    }
    container.appendChild(col);
  }
}

// Big heatmap, grid of 52-53 columns by 7 rows
function renderHeatmapBig(){
  const cont = document.getElementById('bigHeatmap');
  cont.innerHTML = '';
  const grid = document.createElement('div');
  grid.className = 'heat-grid';
  // create 365 cells
  for (let i=0;i<365;i++){
    const cell = document.createElement('div');
    cell.className = 'heat-cell';
    const val = heatData[i] || 0;
    cell.style.background = heatColor(val);
    cell.title = `Day ${i+1}: ${val} minutes`;
    grid.appendChild(cell);
  }
  cont.appendChild(grid);
}
function heatColor(minutes){
  if (minutes <= 0) return '#f3f4f6';
  if (minutes < 10) return '#dbeafe';
  if (minutes < 30) return '#93c5fd';
  if (minutes < 60) return '#60a5fa';
  return '#1e3a8a';
}

/* ----------------- Page-Time Prediction ----------------- */
function predictFinish(){
  const pagesToday = Number(document.getElementById('pagesToday').value) || 0;
  const totalPages = Number(document.getElementById('totalPages').value) || 0;
  const speed = Number(document.getElementById('speed').value) || 0.5; // pages per minute

  // derive average daily reading minutes from heatData last 7 days:
  const last7 = heatData.slice(Math.max(0, heatData.length - 7));
  const avgMinutes = last7.reduce((s,a)=>s+a,0) / (last7.length || 1);
  const predictedPagesPerDay = avgMinutes * speed;

  // if user provided pagesToday, we can blend: we compute a new avg = (predictedPagesPerDay + pagesToday)/2
  const blended = (predictedPagesPerDay + (pagesToday || predictedPagesPerDay)) / 2;

  const remaining = Math.max(0, totalPages - pagesToday);
  let days = Infinity;
  if (blended > 0) days = Math.ceil(remaining / blended);
  const textEl = document.getElementById('predictionText');
  const details = document.getElementById('predictionDetails');

  if (!totalPages || totalPages <= pagesToday) {
    textEl.textContent = "You're done or invalid total pages.";
    details.textContent = "";
    return;
  }
  if (!isFinite(days)) {
    textEl.textContent = "Can't predict (no reading speed data).";
    details.textContent = "Try entering pages read today or adjust reading speed.";
    return;
  }

  textEl.textContent = `At your current speed, you'll finish this book in ${days} day${days>1?'s':''}.`;
  details.textContent = `Based on avg ${Math.round(predictedPagesPerDay*10)/10} pages/day (from recent activity) and today's ${pagesToday} pages.`;
}

/* --------------- Init render --------------- */
renderHeatmapSmall();
renderHeatmapBig();

/* Chart: optionally animate based on mood data updated above */
renderChart();

/* helper: renderChart definition moved below to keep code readable */
function renderChart(){
  // update moodPie already created earlier; re-draw label counts demo handled
  // nothing else needed here
}

/* Expose some functions for console testing */
window.predictFinish = predictFinish;
window.startScanner = startScanner;
window.stopScanner = stopScanner;
window.openBookInternal = openBookInternal;
</script>

</body>
</html>
