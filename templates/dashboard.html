<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Library Habit Tracker â€” Dashboard</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- QR scanner -->
  <script src="https://unpkg.com/html5-qrcode"></script>

  <style>
    :root {
      --card: #ffffff;
      --muted: #475569;
      --accent: #2563eb;
      --radius: 12px;
      --shadow: 0 8px 24px rgba(15,23,42,0.06);
    }
    *{box-sizing:border-box;font-family:Inter,system-ui,'Poppins',sans-serif}

    /* âœ¨ Modern Bookshelf Background (Option B) */
    body{
      margin:0;
      background-image:url('https://i.postimg.cc/j2fvLFNG/white-bookshelf-bg.jpg');
      background-size:cover;
      background-position:center;
      background-attachment:fixed;
      padding:20px;
      color:#0f172a;
    }

    .container{max-width:900px;margin:0 auto;}
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;background:rgba(255,255,255,0.9);padding:14px;border-radius:12px;backdrop-filter:blur(6px);}
    h1{font-size:22px;margin:0;font-weight:600}

    .card{
      background:rgba(255,255,255,0.92);
      border-radius:var(--radius);
      padding:16px;
      box-shadow:var(--shadow);
      margin-bottom:14px;
      backdrop-filter:blur(8px);
    }
    label{display:block;margin-bottom:6px;color:var(--muted);font-size:14px}
    select,input[type="text"],input[type="number"]{
      width:100%;padding:10px;border-radius:8px;border:1px solid #d1d5db;font-size:14px;margin-bottom:8px;background:rgba(255,255,255,0.85);
    }
    .btn{background:var(--accent);color:white;padding:8px 12px;border-radius:8px;border:none;cursor:pointer}
    .btn-ghost{background:transparent;color:var(--accent);border:1px solid #dbeafe;padding:8px 10px;border-radius:8px;cursor:pointer}
    .small{font-size:13px;padding:6px 10px}
    .row{display:flex;gap:10px}
    .result{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:8px;border:1px solid #f1f5f9;background:#fcfdff;margin-bottom:8px}
    .meta{color:var(--muted);font-size:13px}

    /* ðŸ“… Heatmap */
    .heat-grid { display:grid; grid-template-columns: repeat(53, 9px); gap:4px; padding:6px; }
    .heat-cell{width:9px;height:9px;border-radius:2px;background:#eef2ff;border:1px solid rgba(15,23,42,0.03)}

    /* ðŸ”¥ Streak Controls */
    .streak-controls{display:flex;align-items:center;gap:12px;margin-top:10px}
    .streak-btn{
      width:32px;height:32px;font-size:20px;font-weight:bold;
      display:flex;justify-content:center;align-items:center;
      border-radius:8px;border:1px solid #d0d7e3;
      background:white;color:#334155;cursor:pointer;
      transition:0.2s;
    }
    .streak-btn:hover{background:#e5edff}

    @media (max-width:640px){
      .row{flex-direction:column}
      .heat-grid{grid-template-columns:repeat(20,9px)}
    }
  </style>
</head>
<body>

<div class="container">

  <header>
    <h1>ðŸ“š Library Habit Tracker</h1>
    <div style="color:var(--muted)">Welcome back, Reader!</div>
  </header>

  <!-- FEELING -->
  <div class="card">
    <label>How are you feeling today?</label>
    <select id="feeling">
      <option>Select feeling</option>
      <option>ðŸ˜Š Happy</option>
      <option>ðŸ˜Œ Calm</option>
      <option>ðŸ¤© Motivated</option>
      <option>ðŸ˜” Tired</option>
      <option>ðŸ˜¤ Stressed</option>
      <option>ðŸ˜´ Sleepy</option>
    </select>
    <div style="font-size:13px;color:var(--muted)">Selected: <b id="feelingNow">â€”</b></div>
  </div>

  <!-- SEARCH -->
  <div class="card">
    <label>Search Computer Science Books</label>
    <div class="row">
      <input id="searchBox" type="text" placeholder="e.g. algorithms, OS, CN, DBMS" />
      <button class="btn small" onclick="doSearch()">Search</button>
    </div>
    <div id="searchResults" style="margin-top:10px"></div>
  </div>

  <!-- QR -->
  <div class="card">
    <label>QR / ISBN Scanner</label>
    <div class="row">
      <button class="btn small" onclick="startScanner()">Start Scan</button>
      <button class="btn-ghost small" onclick="stopScanner()">Stop</button>
      <label class="btn-ghost small">
        Upload QR
        <input id="qrFile" type="file" accept="image/*" style="display:none" onchange="scanFromFile(event)">
      </label>
    </div>
    <div id="reader" style="margin-top:10px;height:180px;background:#000;color:white;display:flex;justify-content:center;align-items:center;border-radius:8px;">
      Ready
    </div>
    <div id="scanInfo" class="meta" style="margin-top:6px"></div>
  </div>

  <!-- STREAK -->
  <div class="card">
    <label>Reading Streak</label>
    <div style="font-size:22px;font-weight:700" id="streakCount">0 days</div>
    <div class="meta" id="totalMins">0 minutes total</div>

    <div class="streak-controls">
      <div class="streak-btn" onclick="decStreak()">âˆ’</div>
      <button class="btn small" onclick="logTodayMinutesPrompt()">Log Todayâ€™s Minutes</button>
      <div class="streak-btn" onclick="incStreak()">+</div>
    </div>
  </div>

  <!-- HEATMAP -->
  <div class="card">
    <label>Reading Heatmap (Year)</label>
    <div id="heatGrid" class="heat-grid"></div>
  </div>

  <!-- AI SUMMARY -->
  <div class="card">
    <label>AI Summary Generator</label>
    <div class="row">
      <input id="summaryBookId" type="number" placeholder="Book ID (e.g. 1)">
      <button class="btn small" onclick="generateSummary()">Generate</button>
    </div>
    <div id="summaryResult" class="meta"></div>
  </div>

  <!-- TIMER -->
  <div class="card">
    <label>Read-Aloud / Focus Timer</label>
    <div style="font-size:22px;font-weight:700" id="timerDisplay">00:00:00</div>
    <div class="row" style="margin-top:8px">
      <button class="btn small" onclick="startTimer()">Start</button>
      <button class="btn-ghost small" onclick="pauseTimer()">Pause</button>
      <button class="btn-ghost small" onclick="stopTimer()">Stop</button>
    </div>
    <div class="meta" style="margin-top:5px">Adds minutes to streak automatically</div>
  </div>

</div>

<script>
/* FEELINGS */
document.getElementById("feeling").addEventListener("change", e=>{
  document.getElementById("feelingNow").textContent = e.target.value;
});

/* SEARCH */
async function doSearch(){
  const q=document.getElementById("searchBox").value.trim();
  const out=document.getElementById("searchResults");
  if(!q){ out.innerHTML=""; return; }
  out.innerHTML="Searching...";

  const res=await fetch("/api/search?q="+q);
  const data=await res.json();

  out.innerHTML="";
  data.forEach(b=>{
    out.innerHTML += `
      <div class="result">
        <div><b>${b.title}</b><br><span class="meta">${b.author}</span></div>
        <button class="btn small" onclick="location.href='/read-book/${b.id}'">Read</button>
      </div>
    `;
  });
}

/* QR */
let scanner=null;
async function startScanner(){
  if(scanner) return;
  scanner=new Html5Qrcode("reader");
  const cams=await Html5Qrcode.getCameras();
  if(!cams.length) return;

  scanner.start(cams[0].id,{fps:10,qrbox:200},qr=>{
    document.getElementById("scanInfo").textContent="Scanned: "+qr;
    if(/^\d+$/.test(qr)) location.href="/read-book/"+qr;
  });
}
function stopScanner(){
  if(scanner){ scanner.stop(); scanner.clear(); scanner=null; }
}
function scanFromFile(e){
  const file=e.target.files[0];
  if(!file)return;
  const qr=new Html5Qrcode("reader");
  qr.scanFile(file,true).then(dec=>{
    document.getElementById("scanInfo").textContent="Scanned: "+dec;
  });
}

/* HEATMAP + STREAK */
let heatData=Array.from({length:365},()=>Math.floor(Math.random()*10));

function heatColor(m){
  if(m<=0)return"#eef2ff";
  if(m<10)return"#c7d2fe";
  if(m<20)return"#818cf8";
  return"#4338ca";
}

function getDayOfYear(d){
  const s=new Date(d.getFullYear(),0,0);
  return Math.floor((d-s)/(1000*60*60*24));
}

function renderHeat(){
  const g=document.getElementById("heatGrid");
  g.innerHTML="";
  heatData.forEach(m=>{
    const c=document.createElement("div");
    c.className="heat-cell";
    c.style.background=heatColor(m);
    g.appendChild(c);
  });
}

function computeStreak(){
  let today=getDayOfYear(new Date());
  let s=0;
  for(let i=today;i>=0;i--){
    if(!heatData[i]||heatData[i]===0) break;
    s++;
  }
  document.getElementById("streakCount").textContent=s+" days";
  document.getElementById("totalMins").textContent=
    heatData.reduce((a,b)=>a+b,0)+" minutes total";
}

/* Manual streak adjust */
function incStreak(){
  let today=getDayOfYear(new Date());
  heatData[today]=(heatData[today]||0)+20;
  renderHeat(); computeStreak();
}
function decStreak(){
  let today=getDayOfYear(new Date());
  heatData[today]=Math.max(0,(heatData[today]||0)-20);
  renderHeat(); computeStreak();
}

/* Log Today */
function logTodayMinutesPrompt(){
  let m=parseInt(prompt("Minutes read today?","25"));
  if(!m||m<=0)return;
  let d=getDayOfYear(new Date());
  heatData[d]=(heatData[d]||0)+m;
  renderHeat(); computeStreak();
}

/* AI SUMMARY */
function generateSummary(){
  let id=document.getElementById("summaryBookId").value;
  let out=document.getElementById("summaryResult");
  if(!id){ out.textContent="Enter Book ID"; return; }
  out.textContent="Generating summary...";
  setTimeout(()=>{
    out.textContent="Short summary: This book explains concepts with simple clarity. (Demo)";
  },800);
}

/* TIMER */
let tSec=0, interval=null;
function format(s){
  let h=String(Math.floor(s/3600)).padStart(2,"0");
  let m=String(Math.floor((s%3600)/60)).padStart(2,"0");
  let se=String(s%60).padStart(2,"0");
  return `${h}:${m}:${se}`;
}
function startTimer(){
  if(interval)return;
  interval=setInterval(()=>{
    tSec++; document.getElementById("timerDisplay").textContent=format(tSec);
  },1000);
}
function pauseTimer(){
  clearInterval(interval); interval=null;
}
function stopTimer(){
  clearInterval(interval); interval=null;

  let mins=Math.floor(tSec/60);
  if(mins>0){
    let d=getDayOfYear(new Date());
    heatData[d]=(heatData[d]||0)+mins;
    renderHeat(); computeStreak();
  }

  tSec=0;
  document.getElementById("timerDisplay").textContent="00:00:00";
}

/* INIT */
renderHeat();
computeStreak();
</script>

</body>
</html>
